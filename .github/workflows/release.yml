name: Release nf-ospool

on:
  workflow_run:
    workflows: ["nf-ospool CI"]
    types:
      - completed

jobs:
  release:
    name: Create Release
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      startsWith(github.event.workflow_run.head_branch, 'v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0
      
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
      
      - name: Build plugin
        run: ./gradlew assemble
        env:
          GRADLE_OPTS: '-Dorg.gradle.daemon=false'
      
      - name: Get version from build.gradle
        id: get_version
        run: |
          VERSION=$(grep "^version = " build.gradle | sed "s/version = '\(.*\)'/\1/")
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Detected version: ${VERSION}"
      
      - name: Verify plugin JAR exists
        run: |
          ls -lh build/libs/
          test -f build/libs/nf-ospool-${{ steps.get_version.outputs.VERSION }}.jar
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.workflow_run.head_branch }}
          files: |
            build/libs/nf-ospool-${{ steps.get_version.outputs.VERSION }}.jar
          body: |
            # nf-ospool ${{ steps.get_version.outputs.VERSION }}
            
            Nextflow plugin for the Open Science Pool (OSPool) HTCondor environment.
            
            ## Installation
            
            ```groovy
            plugins {
                id 'nf-ospool@${{ steps.get_version.outputs.VERSION }}'
            }
            ```
            
            ## Quick Start
            
            ```groovy
            process.executor = 'ospool'
            
            executor {
                $ospool {
                    submitFileDir = '.nextflow/ospool-submit'
                }
            }
            
            workDir = '/staging/groups/mygroup/nextflow-work'
            ```
            
            See [README.md](README.md) for complete documentation.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
